<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sÃ¡ch Ä‘Æ¡n Ä‘áº·t xe vá»›i Google Login</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #1e2a33;
      color: #fff;
      padding: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    h2 {
      margin-top: 0;
    }
    .search-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .search-bar input,
    .search-bar select {
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      min-width: 160px;
      color: #333;
    }
    .booking-item {
      background: #2f4052;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      word-break: break-word;
      color: #fff;
    }
    .booking-item strong {
      display: inline-block;
      width: 130px;
      color: #ccc;
    }
    .booking-item p {
      margin: 5px 0;
    }
    .pagination {
      margin-top: 20px;
      text-align: center;
    }
    .pagination button {
      padding: 6px 10px;
      margin: 0 4px;
      background-color: #34495e;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .pagination button.active {
      background-color: #1abc9c;
    }
    /* Login & buttons */
    #loginSection {
      margin-bottom: 15px;
    }
    #deleteBtn, #signOutBtn {
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 10px;
      margin-top: 10px;
      display: none;
    }
    #deleteBtn {
      background-color: #c0392b;
      color: #fff;
    }
    #signOutBtn {
      background-color: #e74c3c;
      color: #fff;
    }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h2>ğŸ“„ Danh sÃ¡ch Ä‘Æ¡n Ä‘áº·t xe ğŸš– Taxi24h.Online</h2>

  <div id="loginSection">
    <div id="g_id_onload"
      data-client_id="533150711630-i5cn7antf1h5kau067om4r3hijpqevka.apps.googleusercontent.com"
      data-context="signin"
      data-ux_mode="popup"
      data-callback="handleCredentialResponse"
      data-auto_prompt="false">
    </div>
    <div class="g_id_signin" data-type="standard"></div>
    <button id="deleteBtn">XÃ³a Ä‘Æ¡n Ä‘áº·t xe trÃªn Google Sheets</button>
    <button id="signOutBtn">ÄÄƒng xuáº¥t</button>
  </div>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="TÃ¬m theo Ä‘iá»ƒm Ä‘i/Ä‘áº¿n..." oninput="renderBookings()" disabled />
    <select id="typeFilter" onchange="renderBookings()" disabled>
      <option value="">Táº¥t cáº£ loáº¡i xe</option>
      <option value="4">4 chá»—</option>
      <option value="7">7 chá»—</option>
      <option value="16">16 chá»—</option>
      <option value="truck">Xe táº£i</option>
    </select>
    <input type="date" id="dateFilter" onchange="renderBookings()" disabled />
  </div>

  <div id="bookingList"></div>
  <div class="pagination" id="pagination"></div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykxTVj-B6wC0rHSITzIcW0UydO8TXSD3w0bSqDtK2NjSoQdKwwRS7Iome7-DvF8h6IEQ/exec";
  const SCRIPT_DELETE_URL = "https://script.google.com/macros/s/AKfycbxIYE5HGmuwvAQh7i4owFNU2KsgcypK8I_IwF1t_4Fp3iET4Ejz5MibTpI9SzCK3RFZWA/exec";

  const ITEMS_PER_PAGE = 5;
  let allBookings = [];
  let currentPage = 1;
  let userEmail = null;

  function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  }

  // Báº­t / táº¯t cÃ¡c input tÃ¬m kiáº¿m
  function toggleFilters(enable) {
    document.getElementById('searchInput').disabled = !enable;
    document.getElementById('typeFilter').disabled = !enable;
    document.getElementById('dateFilter').disabled = !enable;
  }

  function renderCarType(type) {
    switch(type) {
      case '4': return '4 chá»—';
      case '7': return '7 chá»—';
      case '16': return '16 chá»—';
      case 'truck': return 'Xe táº£i';
      default: return type;
    }
  }

  function formatDateToISO(dateStr) {
    if (!dateStr) return '';
    const parts = dateStr.split('/');
    if(parts.length !== 3) return dateStr;
    return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
  }

  function maskName(name) {
    if (!name) return "";
    if (name.length <= 2) return name[0] + "*";
    return name.slice(0, 2) + "*".repeat(name.length - 2);
  }

  function maskPhone(phone) {
    if (!phone) return "(KhÃ´ng cÃ³ sá»‘)";
    const str = phone.toString();
    if (str.length <= 5) return str.replace(/.(?=.{2})/g, "*");
    return str.slice(0, 3) + "***" + str.slice(-2);
  }

  async function fetchBookings() {
    try {
      const response = await fetch(SCRIPT_URL);
      const data = await response.json();
      allBookings = data.data || [];
      renderBookings();
    } catch (error) {
      document.getElementById('bookingList').innerHTML = `<p>âš ï¸ Lá»—i táº£i dá»¯ liá»‡u: ${error}</p>`;
    }
  }

  function renderBookings() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const type = document.getElementById('typeFilter').value;
    const date = document.getElementById('dateFilter').value;

    const filtered = allBookings.filter(b => {
      const address = ((b["Tá»«"] || '') + ' ' + (b["Äáº¿n"] || '')).toLowerCase();
      const datetimeRaw = b["NgÃ y giá» Ä‘i"] || '';
      const datetimeISO = formatDateToISO(datetimeRaw.split(' ')[0]);

      const vehicle = b["Loáº¡i xe"] || '';

      return (
        (!search || address.includes(search)) &&
        (!type || vehicle === type) &&
        (!date || datetimeISO === date)
      );
    }).reverse();

    const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
    if(currentPage > totalPages) currentPage = totalPages || 1;

    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const currentItems = filtered.slice(start, end);

    const listContainer = document.getElementById('bookingList');
    listContainer.innerHTML = '';

    if(currentItems.length === 0) {
      listContainer.innerHTML = '<p>KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n nÃ o.</p>';
    } else {
      currentItems.forEach(b => {
        const div = document.createElement('div');
        div.className = 'booking-item';

        const rawName = b["Há» tÃªn"] || "";
        const rawPhone = b["SÄT"] || "(KhÃ´ng cÃ³ sá»‘)";
        const datetimeRaw = b["NgÃ y giá» Ä‘i"] || '';
        const origin = b["Tá»«"] || '';
        const destination = b["Äáº¿n"] || '';
        const vehicle = b["Loáº¡i xe"] || '';
        const twoWay = b["Hai chiá»u"] === 'âœ… CÃ³';
        const night = b["Ban Ä‘Ãªm"] === 'âœ… CÃ³';
        const timeSent = b["Thá»i gian gá»­i"] || '';

        const displayName = maskName(rawName);
        const displayPhone = maskPhone(rawPhone);

        div.innerHTML = `
          <p><strong>ğŸ‘¤ Há» tÃªn:</strong> ${displayName}</p>
          <p><strong>ğŸ“ SÄT:</strong> ${displayPhone}</p>
          <p><strong>ğŸ“… NgÃ y Ä‘i:</strong> ${datetimeRaw || 'ChÆ°a chá»n'}</p>
          <p><strong>ğŸ“ Tá»«:</strong> ${origin}</p>
          <p><strong>ğŸ“ Äáº¿n:</strong> ${destination}</p>
          <p><strong>ğŸš— Loáº¡i xe:</strong> ${renderCarType(vehicle)}</p>
          <p><strong>ğŸ” 2 chiá»u:</strong> ${twoWay ? 'âœ…' : 'âŒ'}</p>
          <p><strong>ğŸŒ™ Ban Ä‘Ãªm:</strong> ${night ? 'âœ…' : 'âŒ'}</p>
          <p><strong>ğŸ•’ Gá»­i lÃºc:</strong> ${timeSent}</p>
        `;

        listContainer.appendChild(div);
      });
    }

    renderPagination(totalPages);
  }

  function renderPagination(totalPages) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    if(totalPages <= 1) return;

    for(let i = 1; i <= totalPages; i++) {
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.classList.toggle('active', i === currentPage);
      btn.onclick = () => {
        currentPage = i;
        renderBookings();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
      pagination.appendChild(btn);
    }
  }

  // XÃ³a dá»¯ liá»‡u Ä‘Æ¡n Ä‘áº·t xe trÃªn Google Sheets
  document.getElementById('deleteBtn').onclick = async () => {
    if(!confirm('Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a toÃ n bá»™ Ä‘Æ¡n Ä‘áº·t xe trÃªn Google Sheets khÃ´ng?')) return;

    try {
      const res = await fetch(SCRIPT_DELETE_URL, { method: 'POST' });
      const data = await res.json();
      if(data.success) {
        alert('ÄÃ£ xÃ³a thÃ nh cÃ´ng!');
        fetchBookings();
      } else {
        alert('XÃ³a tháº¥t báº¡i: ' + (data.message || 'Lá»—i server'));
      }
    } catch(error) {
      alert('Lá»—i khi gá»i API xÃ³a dá»¯ liá»‡u: ' + error);
    }
  };

  // Xá»­ lÃ½ Ä‘Äƒng nháº­p Google
  function handleCredentialResponse(response) {
    const payload = parseJwt(response.credential);
    userEmail = payload.email;
    console.log('ÄÄƒng nháº­p:', userEmail);

    document.querySelector('.g_id_signin').style.display = 'none';

    // Chá»‰ admin má»›i hiá»‡n nÃºt xÃ³a vÃ  báº­t bá»™ lá»c tÃ¬m kiáº¿m
    if(userEmail === 'luannvkr@gmail.com') {  // Thay email admin cá»§a báº¡n
      document.getElementById('deleteBtn').style.display = 'inline-block';
      toggleFilters(true);
    } else {
      toggleFilters(false);
    }

    document.getElementById('signOutBtn').style.display = 'inline-block';

    fetchBookings();
  }

  // ÄÄƒng xuáº¥t
  document.getElementById('signOutBtn').onclick = () => {
    userEmail = null;
    document.getElementById('deleteBtn').style.display = 'none';
    document.getElementById('signOutBtn').style.display = 'none';
    document.querySelector('.g_id_signin').style.display = 'inline-block';
    toggleFilters(false);
    document.getElementById('bookingList').innerHTML = '';
  };

  // Khá»Ÿi táº¡o
  toggleFilters(false);
  fetchBookings();
</script>
</body>
</html>
